<?xml version="1.0" encoding="utf-8"?>
<loomworks>
    <!-- FSM Task Form View -->
    <record id="project_task_view_form_fsm" model="ir.ui.view">
        <field name="name">project.task.form.fsm</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="arch" type="xml">
            <!-- Add FSM fields to header buttons -->
            <xpath expr="//header" position="inside">
                <button name="action_fsm_checkin" string="Check In" type="object"
                        class="btn-primary" icon="fa-map-marker"
                        invisible="not is_fsm or checkin_time"/>
                <button name="action_fsm_checkout" string="Check Out" type="object"
                        class="btn-warning" icon="fa-sign-out"
                        invisible="not is_fsm or not checkin_time or checkout_time"/>
                <button name="action_fsm_mark_done" string="Mark Done" type="object"
                        class="btn-success" icon="fa-check"
                        invisible="not is_fsm or fsm_done"/>
            </xpath>

            <!-- Add FSM indicator -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_open_maps" type="object"
                        class="oe_stat_button" icon="fa-map-marker"
                        invisible="not is_fsm">
                    <span class="o_stat_text">Open Maps</span>
                </button>
                <button type="object" name="action_view_worksheet"
                        class="oe_stat_button" icon="fa-clipboard"
                        invisible="not is_fsm or not worksheet_template_id">
                    <field name="worksheet_completed" widget="boolean" invisible="1"/>
                    <span class="o_stat_text" invisible="worksheet_completed">Fill Worksheet</span>
                    <span class="o_stat_text" invisible="not worksheet_completed">View Worksheet</span>
                </button>
            </xpath>

            <!-- Add FSM tab -->
            <xpath expr="//notebook" position="inside">
                <page string="Field Service" name="fsm" invisible="not is_fsm">
                    <group>
                        <group string="Assignment">
                            <field name="is_fsm" invisible="1"/>
                            <field name="fsm_user_id"/>
                            <field name="planned_date_start"/>
                            <field name="planned_date_end"/>
                        </group>
                        <group string="Status">
                            <field name="fsm_done" readonly="1"/>
                            <field name="total_hours_spent" readonly="1"/>
                            <field name="material_cost" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <group string="Check-in/out" invisible="not checkin_time">
                            <field name="checkin_time" readonly="1"/>
                            <field name="checkin_address" readonly="1"/>
                            <field name="checkout_time" readonly="1"/>
                        </group>
                        <group string="Worksheet" invisible="not worksheet_template_id">
                            <field name="worksheet_template_id"/>
                            <field name="worksheet_completed" readonly="1"/>
                        </group>
                    </group>
                    <group string="Customer Signature" invisible="not customer_signature">
                        <field name="customer_signature" widget="image" readonly="1"/>
                        <field name="customer_signed_by" readonly="1"/>
                        <field name="customer_signed_on" readonly="1"/>
                    </group>
                    <group string="Materials Used">
                        <field name="material_line_ids" nolabel="1">
                            <list editable="bottom">
                                <field name="product_id"/>
                                <field name="name" optional="hide"/>
                                <field name="quantity"/>
                                <field name="product_uom_id" optional="hide"/>
                                <field name="price_unit"/>
                                <field name="subtotal" sum="Total"/>
                            </list>
                        </field>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- FSM Mobile Kanban View -->
    <record id="project_task_view_kanban_fsm" model="ir.ui.view">
        <field name="name">project.task.kanban.fsm</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <kanban class="o_fsm_kanban o_kanban_mobile"
                    default_group_by="stage_id"
                    quick_create="false"
                    records_draggable="true">
                <field name="id"/>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="partner_latitude"/>
                <field name="partner_longitude"/>
                <field name="planned_date_start"/>
                <field name="planned_date_end"/>
                <field name="fsm_done"/>
                <field name="fsm_user_id"/>
                <field name="timer_start"/>
                <field name="color"/>
                <progressbar field="fsm_done" colors='{"True": "success", "False": "muted"}'/>
                <templates>
                    <t t-name="kanban-card">
                        <div class="o_kanban_record o_fsm_task_card">
                            <div class="o_kanban_record_top mb-2">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="name"/>
                                    </strong>
                                </div>
                                <div t-if="record.fsm_done.raw_value" class="badge text-bg-success">
                                    Done
                                </div>
                                <div t-elif="record.timer_start.raw_value" class="badge text-bg-warning">
                                    In Progress
                                </div>
                            </div>
                            <div class="o_kanban_record_body">
                                <div t-if="record.partner_id.value" class="mb-1">
                                    <i class="fa fa-user text-muted me-1"/>
                                    <field name="partner_id"/>
                                </div>
                                <div t-if="record.planned_date_start.value" class="mb-1 text-muted small">
                                    <i class="fa fa-clock-o me-1"/>
                                    <field name="planned_date_start" widget="datetime"/>
                                </div>
                                <div t-if="record.partner_latitude.raw_value" class="mt-2">
                                    <a href="#" t-attf-onclick="window.open('https://maps.google.com/?q={{record.partner_latitude.raw_value}},{{record.partner_longitude.raw_value}}', '_blank')"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fa fa-map-marker"/> Open Maps
                                    </a>
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom mt-2">
                                <div class="oe_kanban_bottom_left">
                                    <field name="fsm_user_id" widget="many2one_avatar_user"/>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <field name="activity_ids" widget="kanban_activity"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- FSM Task List View -->
    <record id="project_task_view_list_fsm" model="ir.ui.view">
        <field name="name">project.task.list.fsm</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <list string="Field Service Tasks"
                  decoration-success="fsm_done"
                  decoration-warning="timer_start and not fsm_done">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="fsm_user_id" widget="many2one_avatar_user"/>
                <field name="planned_date_start"/>
                <field name="total_hours_spent" sum="Total Hours"/>
                <field name="fsm_done" widget="boolean_toggle"/>
                <field name="stage_id"/>
            </list>
        </field>
    </record>

    <!-- FSM Task Search View -->
    <record id="project_task_view_search_fsm" model="ir.ui.view">
        <field name="name">project.task.search.fsm</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <search string="Search FSM Tasks">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="fsm_user_id"/>
                <filter string="My Tasks" name="my_tasks" domain="[('fsm_user_id', '=', uid)]"/>
                <filter string="Today" name="today"
                        domain="[('planned_date_start', '&gt;=', context_today().strftime('%Y-%m-%d 00:00:00')),
                                 ('planned_date_start', '&lt;=', context_today().strftime('%Y-%m-%d 23:59:59'))]"/>
                <filter string="This Week" name="this_week"
                        domain="[('planned_date_start', '&gt;=', (context_today() - relativedelta(days=context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter string="In Progress" name="in_progress" domain="[('timer_start', '!=', False), ('fsm_done', '=', False)]"/>
                <filter string="Completed" name="completed" domain="[('fsm_done', '=', True)]"/>
                <filter string="Pending" name="pending" domain="[('fsm_done', '=', False)]"/>
                <group expand="0" string="Group By">
                    <filter string="Technician" name="group_technician" context="{'group_by': 'fsm_user_id'}"/>
                    <filter string="Customer" name="group_customer" context="{'group_by': 'partner_id'}"/>
                    <filter string="Date" name="group_date" context="{'group_by': 'planned_date_start:day'}"/>
                    <filter string="Status" name="group_done" context="{'group_by': 'fsm_done'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- FSM Tasks Action -->
    <record id="action_fsm_tasks" model="ir.actions.act_window">
        <field name="name">Field Service Tasks</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,list,form,calendar</field>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context">{
            'default_is_fsm': True,
            'search_default_my_tasks': 1,
            'search_default_pending': 1,
        }</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No field service tasks yet
            </p>
            <p>
                Create service orders to dispatch technicians to customer sites.
            </p>
        </field>
    </record>

    <record id="action_fsm_tasks_view_kanban" model="ir.actions.act_window.view">
        <field name="sequence">1</field>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="project_task_view_kanban_fsm"/>
        <field name="act_window_id" ref="action_fsm_tasks"/>
    </record>

    <record id="action_fsm_tasks_view_list" model="ir.actions.act_window.view">
        <field name="sequence">2</field>
        <field name="view_mode">list</field>
        <field name="view_id" ref="project_task_view_list_fsm"/>
        <field name="act_window_id" ref="action_fsm_tasks"/>
    </record>

    <!-- Today's Tasks Action -->
    <record id="action_fsm_tasks_today" model="ir.actions.act_window">
        <field name="name">Today's Tasks</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[('is_fsm', '=', True)]</field>
        <field name="context">{
            'default_is_fsm': True,
            'search_default_my_tasks': 1,
            'search_default_today': 1,
        }</field>
        <field name="search_view_id" ref="project_task_view_search_fsm"/>
    </record>
</loomworks>
