<?xml version="1.0" encoding="utf-8"?>
<loomworks>
    <data noupdate="0">
        <!--
        Salary Rules for US Federal and California payroll.
        These rules implement 2026 tax brackets and rates.
        -->

        <!-- ==================== BASIC RULES ==================== -->

        <!-- Basic Salary (Monthly) -->
        <record id="rule_basic_salary" model="hr.salary.rule">
            <field name="name">Basic Salary</field>
            <field name="code">BASIC</field>
            <field name="sequence">1</field>
            <field name="category_id" ref="category_basic"/>
            <field name="condition_select">python</field>
            <field name="condition_python">result = contract.structure_type_id.wage_type == 'monthly'</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result = contract.wage</field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried'))]"/>
        </record>

        <!-- Basic Hourly Wage -->
        <record id="rule_basic_hourly" model="hr.salary.rule">
            <field name="name">Hourly Wage</field>
            <field name="code">BASIC_HOURLY</field>
            <field name="sequence">1</field>
            <field name="category_id" ref="category_basic"/>
            <field name="condition_select">python</field>
            <field name="condition_python">result = contract.structure_type_id.wage_type == 'hourly'</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# Get hourly rate and hours worked
hourly_rate = contract.hourly_wage or 0.0
hours = worked_days.WORK100.number_of_hours if hasattr(worked_days, 'WORK100') else 0.0
result = hourly_rate * hours
            </field>
            <field name="struct_ids" eval="[(4, ref('structure_us_hourly'))]"/>
        </record>

        <!-- Bonus Input -->
        <record id="rule_bonus" model="hr.salary.rule">
            <field name="name">Bonus</field>
            <field name="code">BONUS</field>
            <field name="sequence">5</field>
            <field name="category_id" ref="category_alw"/>
            <field name="condition_select">python</field>
            <field name="condition_python">result = inputs.BONUS > 0</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result = inputs.BONUS</field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried')), (4, ref('structure_us_hourly'))]"/>
        </record>

        <!-- ==================== GROSS ==================== -->

        <!-- Gross Salary -->
        <record id="rule_gross" model="hr.salary.rule">
            <field name="name">Gross Salary</field>
            <field name="code">GROSS</field>
            <field name="sequence">100</field>
            <field name="category_id" ref="category_gross"/>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result = categories.BASIC + categories.ALW</field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried')), (4, ref('structure_us_hourly'))]"/>
        </record>

        <!-- ==================== FEDERAL TAX RULES ==================== -->

        <!-- Social Security (Employee) - 6.2% up to $184,500 wage base (2026) -->
        <record id="rule_ss_ee" model="hr.salary.rule">
            <field name="name">Social Security</field>
            <field name="code">SS_EE</field>
            <field name="sequence">200</field>
            <field name="category_id" ref="category_ded_fed"/>
            <field name="is_tax">True</field>
            <field name="tax_type">social_security</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# Social Security 2026: 6.2% up to $184,500 wage base
SS_RATE = 0.062
SS_WAGE_BASE = 184500.0

# Annualize gross for wage base check
periods = 12  # Monthly
annual_gross = categories.GROSS * periods

# Check YTD earnings (simplified - full version would track actual YTD)
ytd_taxable = min(annual_gross, SS_WAGE_BASE)

# Calculate per-period amount
period_taxable = ytd_taxable / periods
result = -period_taxable * SS_RATE
            </field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried')), (4, ref('structure_us_hourly'))]"/>
            <field name="note">Social Security Tax (OASDI) - Employee portion at 6.2% of wages up to $184,500 (2026)</field>
        </record>

        <!-- Medicare (Employee) - 1.45% no wage limit + 0.9% additional over $200k -->
        <record id="rule_med_ee" model="hr.salary.rule">
            <field name="name">Medicare</field>
            <field name="code">MED_EE</field>
            <field name="sequence">210</field>
            <field name="category_id" ref="category_ded_fed"/>
            <field name="is_tax">True</field>
            <field name="tax_type">medicare</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# Medicare 2026: 1.45% + 0.9% additional over $200,000
MED_RATE = 0.0145
MED_ADD_RATE = 0.009
MED_ADD_THRESHOLD = 200000.0

gross = categories.GROSS
periods = 12  # Monthly
annual_gross = gross * periods

# Base Medicare
tax = gross * MED_RATE

# Additional Medicare (0.9% on wages over $200k)
if annual_gross > MED_ADD_THRESHOLD:
    excess = (annual_gross - MED_ADD_THRESHOLD) / periods
    tax += excess * MED_ADD_RATE

result = -tax
            </field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried')), (4, ref('structure_us_hourly'))]"/>
            <field name="note">Medicare Tax - 1.45% plus additional 0.9% on wages over $200,000</field>
        </record>

        <!-- Federal Income Tax Withholding -->
        <record id="rule_fed_inc" model="hr.salary.rule">
            <field name="name">Federal Income Tax</field>
            <field name="code">FED_INC</field>
            <field name="sequence">220</field>
            <field name="category_id" ref="category_ded_fed"/>
            <field name="is_tax">True</field>
            <field name="tax_type">federal_income</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# Federal Income Tax 2026 - Simplified progressive brackets
# Based on IRS Publication 15-T percentage method
# Note: This is a simplified implementation. Production should use
# the full IRS percentage method tables.

gross = categories.GROSS
periods = 12  # Monthly for salaried, 26 for bi-weekly hourly
annual_gross = gross * periods

# Get filing status from contract
filing_status = contract.filing_status or 'single'
allowances = contract.federal_allowances or 0
additional = contract.additional_federal_withholding or 0

# Standard deduction estimates (2026 projected)
std_deductions = {
    'single': 15700,
    'married': 31400,
    'married_separate': 15700,
    'head_household': 23500,
}

# 2026 Single filer brackets (estimated)
brackets_single = [
    (11925, 0.10),
    (48475, 0.12),
    (103350, 0.22),
    (197300, 0.24),
    (250525, 0.32),
    (626350, 0.35),
    (float('inf'), 0.37),
]

# 2026 Married filing jointly brackets (estimated)
brackets_married = [
    (23850, 0.10),
    (96950, 0.12),
    (206700, 0.22),
    (394600, 0.24),
    (501050, 0.32),
    (751600, 0.35),
    (float('inf'), 0.37),
]

# Select brackets based on filing status
if filing_status in ('married', 'married_separate'):
    brackets = brackets_married
else:
    brackets = brackets_single

# Calculate taxable income
std_ded = std_deductions.get(filing_status, 15700)
allowance_amount = allowances * 4350  # Estimated 2026 exemption
taxable_income = max(0, annual_gross - std_ded - allowance_amount)

# Calculate tax using brackets
tax = 0
prev_bracket = 0
for bracket, rate in brackets:
    if taxable_income > bracket:
        tax += (bracket - prev_bracket) * rate
        prev_bracket = bracket
    else:
        tax += (taxable_income - prev_bracket) * rate
        break

# De-annualize
per_period = tax / periods

# Add additional withholding
per_period += additional

result = -per_period
            </field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried')), (4, ref('structure_us_hourly'))]"/>
            <field name="note">Federal Income Tax based on 2026 IRS tax brackets and filing status</field>
        </record>

        <!-- ==================== CALIFORNIA STATE TAX RULES ==================== -->

        <!-- California PIT (Personal Income Tax) -->
        <record id="rule_ca_pit" model="hr.salary.rule">
            <field name="name">California State Tax (PIT)</field>
            <field name="code">CA_PIT</field>
            <field name="sequence">300</field>
            <field name="category_id" ref="category_ded_state"/>
            <field name="is_tax">True</field>
            <field name="tax_type">state_income</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# California Personal Income Tax (PIT) 2026
# Progressive brackets - single filer

gross = categories.GROSS
periods = 12
annual_gross = gross * periods

filing_status = contract.filing_status or 'single'
allowances = contract.state_allowances or 0
additional = contract.additional_state_withholding or 0

# Standard deduction (2026 estimate)
std_ded = 5540 if filing_status in ('single', 'married_separate') else 11080

# CA 2026 brackets (single, estimated)
brackets = [
    (10756, 0.01),
    (25499, 0.02),
    (40243, 0.04),
    (55866, 0.06),
    (70606, 0.08),
    (360659, 0.093),
    (432791, 0.103),
    (721318, 0.113),
    (float('inf'), 0.123),
]

# Exemption credit
exemption_credit = allowances * 154.00  # Estimated 2026

# Calculate taxable income
taxable_income = max(0, annual_gross - std_ded)

# Calculate tax
tax = 0
prev_bracket = 0
for bracket, rate in brackets:
    if taxable_income > bracket:
        tax += (bracket - prev_bracket) * rate
        prev_bracket = bracket
    else:
        tax += (taxable_income - prev_bracket) * rate
        break

# Apply exemption credit
tax = max(0, tax - exemption_credit)

# De-annualize
per_period = tax / periods + additional

result = -per_period
            </field>
            <field name="struct_ids" eval="[(4, ref('structure_ca_salaried')), (4, ref('structure_ca_hourly'))]"/>
            <field name="note">California State Personal Income Tax (PIT) based on 2026 FTB tax brackets</field>
        </record>

        <!-- California SDI (State Disability Insurance) -->
        <record id="rule_ca_sdi" model="hr.salary.rule">
            <field name="name">California SDI</field>
            <field name="code">CA_SDI</field>
            <field name="sequence">310</field>
            <field name="category_id" ref="category_ded_state"/>
            <field name="is_tax">True</field>
            <field name="tax_type">state_disability</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# California State Disability Insurance (SDI) 2026
# Rate: 1.3% - No wage cap (per SB 951)
SDI_RATE = 0.013

gross = categories.GROSS
result = -gross * SDI_RATE
            </field>
            <field name="struct_ids" eval="[(4, ref('structure_ca_salaried')), (4, ref('structure_ca_hourly'))]"/>
            <field name="note">California State Disability Insurance (SDI) at 1.3% with no wage cap (per SB 951)</field>
        </record>

        <!-- ==================== COMPANY CONTRIBUTIONS ==================== -->

        <!-- Company Social Security -->
        <record id="rule_ss_er" model="hr.salary.rule">
            <field name="name">Company Social Security</field>
            <field name="code">SS_ER</field>
            <field name="sequence">400</field>
            <field name="category_id" ref="category_comp"/>
            <field name="appears_on_payslip">False</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# Employer Social Security - matches employee at 6.2%
result = abs(rules.SS_EE) if rules.SS_EE else 0
            </field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried')), (4, ref('structure_us_hourly'))]"/>
        </record>

        <!-- Company Medicare -->
        <record id="rule_med_er" model="hr.salary.rule">
            <field name="name">Company Medicare</field>
            <field name="code">MED_ER</field>
            <field name="sequence">410</field>
            <field name="category_id" ref="category_comp"/>
            <field name="appears_on_payslip">False</field>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">
# Employer Medicare - matches employee at 1.45% (no additional)
MED_RATE = 0.0145
result = categories.GROSS * MED_RATE
            </field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried')), (4, ref('structure_us_hourly'))]"/>
        </record>

        <!-- ==================== NET ==================== -->

        <!-- Net Salary -->
        <record id="rule_net" model="hr.salary.rule">
            <field name="name">Net Salary</field>
            <field name="code">NET</field>
            <field name="sequence">999</field>
            <field name="category_id" ref="category_net"/>
            <field name="amount_select">code</field>
            <field name="amount_python_compute">result = categories.GROSS + categories.DED</field>
            <field name="struct_ids" eval="[(4, ref('structure_us_salaried')), (4, ref('structure_us_hourly'))]"/>
        </record>
    </data>
</loomworks>
