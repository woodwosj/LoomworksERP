<?xml version="1.0" encoding="utf-8"?>
<loomworks>

    <!-- Extend MRP BOM Form View with PLM fields -->
    <record id="mrp_bom_form_view_plm_inherit" model="ir.ui.view">
        <field name="name">mrp.bom.form.plm.inherit</field>
        <field name="model">mrp.bom</field>
        <field name="inherit_id" ref="mrp.mrp_bom_form_view"/>
        <field name="arch" type="xml">
            <!-- Add warning banner for non-current revisions -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-warning text-center" role="alert"
                     invisible="is_current_revision or lifecycle_state == 'draft'">
                    <strong>This is not the current active revision.</strong>
                    <span invisible="lifecycle_state != 'obsolete'"> This BOM is obsolete.</span>
                </div>
            </xpath>

            <!-- Add button box buttons -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_ecos"
                        icon="fa-clipboard" invisible="pending_eco_count == 0">
                    <field name="pending_eco_count" string="Pending ECOs" widget="statinfo"/>
                </button>
                <button class="oe_stat_button" type="object" name="action_view_revisions"
                        icon="fa-history" invisible="revision_count == 0">
                    <field name="revision_count" string="Revisions" widget="statinfo"/>
                </button>
            </xpath>

            <!-- Add revision and lifecycle fields after type -->
            <xpath expr="//field[@name='type']" position="after">
                <field name="revision_code"/>
                <field name="lifecycle_state" widget="badge"
                       decoration-info="lifecycle_state == 'draft'"
                       decoration-warning="lifecycle_state == 'review'"
                       decoration-success="lifecycle_state == 'released'"
                       decoration-muted="lifecycle_state == 'obsolete'"/>
            </xpath>

            <!-- Add PLM tab in notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="PLM" name="plm">
                    <group>
                        <group string="Version Control">
                            <field name="revision_code"/>
                            <field name="lifecycle_state"/>
                            <field name="is_current_revision"/>
                            <field name="previous_bom_id"/>
                        </group>
                        <group string="Actions">
                            <button name="action_create_revision" string="Create New Revision (via ECO)"
                                    type="object" class="btn-secondary" icon="fa-plus"/>
                            <button name="action_compare_revisions" string="Compare Revisions"
                                    type="object" class="btn-secondary" icon="fa-exchange"
                                    invisible="revision_count == 0"/>
                            <button name="action_set_released" string="Release"
                                    type="object" class="btn-success" icon="fa-check"
                                    invisible="lifecycle_state in ('released', 'obsolete')"/>
                            <button name="action_set_obsolete" string="Mark Obsolete"
                                    type="object" class="btn-warning" icon="fa-archive"
                                    invisible="lifecycle_state == 'obsolete'"
                                    confirm="Are you sure you want to mark this BOM as obsolete?"/>
                        </group>
                    </group>
                    <separator string="Engineering Change Orders"/>
                    <field name="eco_ids" readonly="1">
                        <list create="false">
                            <field name="name"/>
                            <field name="title"/>
                            <field name="state"/>
                            <field name="approval_state"/>
                            <field name="requester_id"/>
                        </list>
                    </field>
                    <separator string="Revision History"/>
                    <field name="revision_ids" readonly="1">
                        <list create="false">
                            <field name="revision_code"/>
                            <field name="revision_date"/>
                            <field name="eco_id"/>
                            <field name="created_by_id"/>
                            <field name="line_count"/>
                        </list>
                    </field>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Extend MRP BOM Tree View -->
    <record id="mrp_bom_tree_view_plm_inherit" model="ir.ui.view">
        <field name="name">mrp.bom.tree.plm.inherit</field>
        <field name="model">mrp.bom</field>
        <field name="inherit_id" ref="mrp.mrp_bom_tree_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='code']" position="after">
                <field name="revision_code" optional="show"/>
                <field name="lifecycle_state" widget="badge" optional="show"
                       decoration-success="lifecycle_state == 'released'"
                       decoration-muted="lifecycle_state == 'obsolete'"/>
            </xpath>
        </field>
    </record>

    <!-- Extend MRP BOM Search View -->
    <record id="mrp_bom_search_view_plm_inherit" model="ir.ui.view">
        <field name="name">mrp.bom.search.plm.inherit</field>
        <field name="model">mrp.bom</field>
        <field name="inherit_id" ref="mrp.view_mrp_bom_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='inactive']" position="before">
                <separator/>
                <filter string="Current Revision" name="current_revision"
                        domain="[('is_current_revision', '=', True)]"/>
                <filter string="Released" name="released"
                        domain="[('lifecycle_state', '=', 'released')]"/>
                <filter string="Obsolete" name="obsolete"
                        domain="[('lifecycle_state', '=', 'obsolete')]"/>
                <filter string="Has Pending ECO" name="has_pending_eco"
                        domain="[('eco_ids.state', 'not in', ['done', 'cancelled'])]"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter string="Lifecycle State" name="group_lifecycle"
                        context="{'group_by': 'lifecycle_state'}"/>
            </xpath>
        </field>
    </record>

</loomworks>
