<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Portal Sign Document Page -->
    <template id="portal_sign_document" name="Sign Document">
        <t t-call="portal.portal_layout">
            <t t-set="no_header" t-value="True"/>
            <t t-set="no_footer" t-value="True"/>

            <div class="o_sign_document_main">
                <!-- Header -->
                <div class="o_sign_header bg-primary text-white p-3">
                    <div class="container-fluid">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <h4 class="mb-0">
                                    <i class="fa fa-file-text-o me-2"/>
                                    <t t-out="request.template_id.name"/>
                                </h4>
                            </div>
                            <div class="col-auto ms-auto">
                                <span class="badge bg-light text-dark">
                                    <t t-out="signer.role_id.name"/>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Viewer -->
                <div class="o_sign_document_viewer p-3">
                    <div class="container-fluid">
                        <div class="row">
                            <!-- PDF Preview -->
                            <div class="col-lg-9">
                                <div class="card">
                                    <div class="card-body p-0">
                                        <div id="sign-document-container" class="o_sign_pdf_container position-relative"
                                             data-request-id="request.id"
                                             data-signer-id="signer.id"
                                             data-page-count="request.template_id.page_count">
                                            <!-- PDF pages will be rendered here -->
                                            <t t-foreach="range(1, request.template_id.page_count + 1)" t-as="page_num">
                                                <div class="o_sign_page position-relative mb-3"
                                                     t-attf-data-page="#{page_num}">
                                                    <img t-attf-src="/sign/preview/#{request.access_token}/#{page_num}"
                                                         class="img-fluid w-100 border"/>
                                                    <!-- Signature fields overlay -->
                                                    <t t-foreach="items.filtered(lambda i: i.page_number == page_num)" t-as="item">
                                                        <div class="o_sign_field position-absolute"
                                                             t-att-data-item-id="item.id"
                                                             t-att-data-type="item.type_id.technical_name"
                                                             t-att-data-required="item.required"
                                                             t-attf-style="left: #{item.pos_x}%; top: #{item.pos_y}%; width: #{item.width}%; height: #{item.height}%;">
                                                            <t t-if="item.type_id.item_type == 'signature'">
                                                                <div class="o_sign_signature_field h-100 w-100 border border-primary rounded bg-light d-flex align-items-center justify-content-center cursor-pointer"
                                                                     data-bs-toggle="modal" data-bs-target="#signatureModal">
                                                                    <span class="text-primary">
                                                                        <i class="fa fa-pencil me-1"/>Click to sign
                                                                    </span>
                                                                </div>
                                                            </t>
                                                            <t t-elif="item.type_id.item_type == 'initial'">
                                                                <div class="o_sign_initial_field h-100 w-100 border border-primary rounded bg-light d-flex align-items-center justify-content-center cursor-pointer"
                                                                     data-bs-toggle="modal" data-bs-target="#initialModal">
                                                                    <span class="text-primary">
                                                                        <i class="fa fa-font me-1"/>Initials
                                                                    </span>
                                                                </div>
                                                            </t>
                                                            <t t-elif="item.type_id.item_type == 'date'">
                                                                <input type="date" class="form-control form-control-sm h-100"
                                                                       t-att-data-item-id="item.id"/>
                                                            </t>
                                                            <t t-elif="item.type_id.item_type == 'text'">
                                                                <input type="text" class="form-control form-control-sm h-100"
                                                                       t-att-placeholder="item.placeholder or ''"
                                                                       t-att-data-item-id="item.id"/>
                                                            </t>
                                                            <t t-elif="item.type_id.item_type == 'textarea'">
                                                                <textarea class="form-control form-control-sm h-100"
                                                                          t-att-placeholder="item.placeholder or ''"
                                                                          t-att-data-item-id="item.id"/>
                                                            </t>
                                                            <t t-elif="item.type_id.item_type == 'checkbox'">
                                                                <div class="form-check h-100 d-flex align-items-center justify-content-center">
                                                                    <input type="checkbox" class="form-check-input"
                                                                           t-att-data-item-id="item.id"/>
                                                                </div>
                                                            </t>
                                                            <t t-else="">
                                                                <input type="text" class="form-control form-control-sm h-100"
                                                                       t-att-value="item.type_id.auto_fill and getattr(signer.partner_id, item.type_id.auto_fill_field, '') or ''"
                                                                       t-att-data-item-id="item.id"
                                                                       t-att-readonly="item.type_id.auto_fill"/>
                                                            </t>
                                                        </div>
                                                    </t>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sidebar -->
                            <div class="col-lg-3">
                                <div class="card sticky-top" style="top: 20px;">
                                    <div class="card-header bg-white">
                                        <h5 class="mb-0">Document Information</h5>
                                    </div>
                                    <div class="card-body">
                                        <dl class="row mb-0">
                                            <dt class="col-5">From:</dt>
                                            <dd class="col-7" t-out="request.create_uid.name"/>

                                            <dt class="col-5">Document:</dt>
                                            <dd class="col-7" t-out="request.template_id.name"/>

                                            <t t-if="request.expire_date">
                                                <dt class="col-5">Expires:</dt>
                                                <dd class="col-7" t-out="request.expire_date"/>
                                            </t>

                                            <dt class="col-5">Your Role:</dt>
                                            <dd class="col-7" t-out="signer.role_id.name"/>
                                        </dl>
                                    </div>
                                    <div class="card-footer bg-white">
                                        <button type="button" id="btn-sign-submit" class="btn btn-primary w-100 mb-2">
                                            <i class="fa fa-check me-2"/>Sign Document
                                        </button>
                                        <button type="button" id="btn-sign-refuse" class="btn btn-outline-danger w-100">
                                            <i class="fa fa-times me-2"/>Refuse to Sign
                                        </button>
                                    </div>
                                </div>

                                <!-- Message from sender -->
                                <t t-if="request.message">
                                    <div class="card mt-3">
                                        <div class="card-header bg-white">
                                            <h6 class="mb-0">Message from sender</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-0" t-out="request.message"/>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signature Modal -->
            <div class="modal fade" id="signatureModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Draw Your Signature</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"/>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs mb-3" role="tablist">
                                <li class="nav-item">
                                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-draw">Draw</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-type">Type</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-upload">Upload</button>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="tab-draw">
                                    <canvas id="signature-canvas" class="border w-100" height="200"/>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="btn-clear-signature">
                                        <i class="fa fa-eraser me-1"/>Clear
                                    </button>
                                </div>
                                <div class="tab-pane fade" id="tab-type">
                                    <input type="text" class="form-control mb-2" id="signature-text" placeholder="Type your name"/>
                                    <div class="signature-preview p-3 border rounded text-center" style="font-family: 'Brush Script MT', cursive; font-size: 32px;">
                                        <span id="signature-text-preview"/>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="tab-upload">
                                    <input type="file" class="form-control" id="signature-upload" accept="image/*"/>
                                    <div class="mt-2 text-center">
                                        <img id="signature-upload-preview" class="img-fluid" style="max-height: 150px; display: none;"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="btn-adopt-signature">Adopt Signature</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Initial Modal -->
            <div class="modal fade" id="initialModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Your Initials</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"/>
                        </div>
                        <div class="modal-body">
                            <canvas id="initial-canvas" class="border w-100" height="100"/>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="btn-clear-initial">
                                <i class="fa fa-eraser me-1"/>Clear
                            </button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="btn-adopt-initial">Adopt Initials</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Include signing JavaScript -->
            <script type="text/javascript" src="/loomworks_sign/static/src/js/sign_portal.js"/>
        </t>
    </template>

    <!-- Sign Complete Page -->
    <template id="portal_sign_complete" name="Signature Complete">
        <t t-call="portal.portal_layout">
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="card text-center">
                            <div class="card-body py-5">
                                <div class="mb-4">
                                    <i class="fa fa-check-circle text-success" style="font-size: 64px;"/>
                                </div>
                                <h2 class="mb-3">Document Signed Successfully</h2>
                                <p class="text-muted">
                                    Thank you for signing <strong t-out="request.template_id.name"/>.
                                </p>
                                <p class="text-muted">
                                    All parties will receive a copy of the signed document once everyone has signed.
                                </p>
                                <hr class="my-4"/>
                                <p class="small text-muted mb-0">
                                    <i class="fa fa-lock me-1"/>
                                    This document was signed electronically using Loomworks Sign.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Sign Refused Page -->
    <template id="portal_sign_refused" name="Signature Refused">
        <t t-call="portal.portal_layout">
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="card text-center">
                            <div class="card-body py-5">
                                <div class="mb-4">
                                    <i class="fa fa-times-circle text-danger" style="font-size: 64px;"/>
                                </div>
                                <h2 class="mb-3">Signature Refused</h2>
                                <p class="text-muted">
                                    You have refused to sign <strong t-out="request.template_id.name"/>.
                                </p>
                                <p class="text-muted">
                                    The document sender has been notified of your decision.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Sign Error Page -->
    <template id="portal_sign_error" name="Signature Error">
        <t t-call="portal.portal_layout">
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="card text-center">
                            <div class="card-body py-5">
                                <div class="mb-4">
                                    <i class="fa fa-exclamation-triangle text-warning" style="font-size: 64px;"/>
                                </div>
                                <h2 class="mb-3">Access Error</h2>
                                <p class="text-muted" t-out="error_message or 'Unable to access this document.'"/>
                                <p class="text-muted">
                                    If you believe this is an error, please contact the document sender.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

</odoo>
